"use strict";function send(e,r,t){return new SendStream(e,r,t)}function SendStream(e,r,t){Stream.call(this);var a=t||{};if(this.options=a,this.path=r,this.req=e,this._acceptRanges=void 0!==a.acceptRanges?Boolean(a.acceptRanges):!0,this._cacheControl=void 0!==a.cacheControl?Boolean(a.cacheControl):!0,this._etag=void 0!==a.etag?Boolean(a.etag):!0,this._dotfiles=void 0!==a.dotfiles?a.dotfiles:"ignore","ignore"!==this._dotfiles&&"allow"!==this._dotfiles&&"deny"!==this._dotfiles)throw new TypeError('dotfiles option must be "allow", "deny", or "ignore"');this._hidden=Boolean(a.hidden),void 0!==a.hidden&&deprecate("hidden: use dotfiles: '"+(this._hidden?"allow":"ignore")+"' instead"),void 0===a.dotfiles&&(this._dotfiles=void 0),this._extensions=void 0!==a.extensions?normalizeList(a.extensions,"extensions option"):[],this._index=void 0!==a.index?normalizeList(a.index,"index option"):["index.html"],this._lastModified=void 0!==a.lastModified?Boolean(a.lastModified):!0,this._maxage=a.maxAge||a.maxage,this._maxage="string"==typeof this._maxage?ms(this._maxage):Number(this._maxage),this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),MAX_MAXAGE),this._root=a.root?resolve(a.root):null,!this._root&&a.from&&this.from(a.from)}function clearHeaders(e){for(var r=getHeaderNames(e),t=0;t<r.length;t++)e.removeHeader(r[t])}function collapseLeadingSlashes(e){for(var r=0;r<e.length&&"/"===e[r];r++);return r>1?"/"+e.substr(r):e}function containsDotFile(e){for(var r=0;r<e.length;r++)if("."===e[r][0])return!0;return!1}function contentRange(e,r,t){return e+" "+(t?t.start+"-"+t.end:"*")+"/"+r}function createHtmlDocument(e,r){return'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>'+e+"</title>\n</head>\n<body>\n<pre>"+r+"</pre>\n</body>\n"}function decode(e){try{return decodeURIComponent(e)}catch(r){return-1}}function getHeaderNames(e){return"function"!=typeof e.getHeaderNames?Object.keys(e._headers||{}):e.getHeaderNames()}function headersSent(e){return"boolean"!=typeof e.headersSent?Boolean(e._header):e.headersSent}function normalizeList(e,r){for(var t=[].concat(e||[]),a=0;a<t.length;a++)if("string"!=typeof t[a])throw new TypeError(r+" must be array of strings or false");return t}function parseHttpDate(e){var r=e&&Date.parse(e);return"number"==typeof r?r:NaN}function setHeaders(e,r){for(var t=Object.keys(r),a=0;a<t.length;a++){var n=t[a];e.setHeader(n,r[n])}}var createError=require("http-errors"),debug=require("debug")("send"),deprecate=require("depd")("send"),destroy=require("destroy"),encodeUrl=require("encodeurl"),escapeHtml=require("escape-html"),etag=require("etag"),EventEmitter=require("events").EventEmitter,fresh=require("fresh"),fs=require("fs"),mime=require("mime"),ms=require("ms"),onFinished=require("on-finished"),parseRange=require("range-parser"),path=require("path"),statuses=require("statuses"),Stream=require("stream"),util=require("util"),extname=path.extname,join=path.join,normalize=path.normalize,resolve=path.resolve,sep=path.sep,BYTES_RANGE_REGEXP=/^ *bytes=/,TOKEN_LIST_REGEXP=/ *, */,MAX_MAXAGE=31536e6,UP_PATH_REGEXP=/(?:^|[\\/])\.\.(?:[\\/]|$)/;module.exports=send,module.exports.mime=mime;var listenerCount=EventEmitter.listenerCount||function(e,r){return e.listeners(r).length};util.inherits(SendStream,Stream),SendStream.prototype.etag=deprecate["function"](function(e){return this._etag=Boolean(e),debug("etag %s",this._etag),this},"send.etag: pass etag as option"),SendStream.prototype.hidden=deprecate["function"](function(e){return this._hidden=Boolean(e),this._dotfiles=void 0,debug("hidden %s",this._hidden),this},"send.hidden: use dotfiles option"),SendStream.prototype.index=deprecate["function"](function t(e){var t=e?normalizeList(e,"paths argument"):[];return debug("index %o",e),this._index=t,this},"send.index: pass index as option"),SendStream.prototype.root=function(e){return this._root=resolve(String(e)),debug("root %s",this._root),this},SendStream.prototype.from=deprecate["function"](SendStream.prototype.root,"send.from: pass root as option"),SendStream.prototype.root=deprecate["function"](SendStream.prototype.root,"send.root: pass root as option"),SendStream.prototype.maxage=deprecate["function"](function(e){return this._maxage="string"==typeof e?ms(e):Number(e),this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),MAX_MAXAGE),debug("max-age %d",this._maxage),this},"send.maxage: pass maxAge as option"),SendStream.prototype.error=function(e,r){if(0!==listenerCount(this,"error"))return this.emit("error",createError(e,r,{expose:!1}));var t=this.res,a=statuses[e]||String(e),n=createHtmlDocument("Error",escapeHtml(a));clearHeaders(t),r&&r.headers&&setHeaders(t,r.headers),t.statusCode=e,t.setHeader("Content-Type","text/html; charset=UTF-8"),t.setHeader("Content-Length",Buffer.byteLength(n)),t.setHeader("Content-Security-Policy","default-src 'self'"),t.setHeader("X-Content-Type-Options","nosniff"),t.end(n)},SendStream.prototype.hasTrailingSlash=function(){return"/"===this.path[this.path.length-1]},SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-match"]||this.req.headers["if-unmodified-since"]||this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]},SendStream.prototype.isPreconditionFailure=function(){var e=this.req,r=this.res,t=e.headers["if-match"];if(t){var a=r.getHeader("ETag");return!a||"*"!==t&&t.split(TOKEN_LIST_REGEXP).every(function(e){return e!==a&&e!=="W/"+a&&"W/"+e!==a})}var n=parseHttpDate(e.headers["if-unmodified-since"]);if(!isNaN(n)){var s=parseHttpDate(r.getHeader("Last-Modified"));return isNaN(s)||s>n}return!1},SendStream.prototype.removeContentHeaderFields=function(){for(var e=this.res,r=getHeaderNames(e),t=0;t<r.length;t++){var a=r[t];"content-"===a.substr(0,8)&&"content-location"!==a&&e.removeHeader(a)}},SendStream.prototype.notModified=function(){var e=this.res;debug("not modified"),this.removeContentHeaderFields(),e.statusCode=304,e.end()},SendStream.prototype.headersAlreadySent=function(){var e=new Error("Can't set headers after they are sent.");debug("headers already sent"),this.error(500,e)},SendStream.prototype.isCachable=function(){var e=this.res.statusCode;return e>=200&&300>e||304===e},SendStream.prototype.onStatError=function(e){switch(e.code){case"ENAMETOOLONG":case"ENOENT":case"ENOTDIR":this.error(404,e);break;default:this.error(500,e)}},SendStream.prototype.isFresh=function(){return fresh(this.req.headers,{etag:this.res.getHeader("ETag"),"last-modified":this.res.getHeader("Last-Modified")})},SendStream.prototype.isRangeFresh=function(){var e=this.req.headers["if-range"];if(!e)return!0;if(-1!==e.indexOf('"')){var r=this.res.getHeader("ETag");return Boolean(r&&-1!==e.indexOf(r))}var t=this.res.getHeader("Last-Modified");return parseHttpDate(t)<=parseHttpDate(e)},SendStream.prototype.redirect=function(e){var r=this.res;if(0!==listenerCount(this,"directory"))return void this.emit("directory",r,e);if(this.hasTrailingSlash())return void this.error(403);var t=encodeUrl(collapseLeadingSlashes(this.path+"/")),a=createHtmlDocument("Redirecting",'Redirecting to <a href="'+escapeHtml(t)+'">'+escapeHtml(t)+"</a>");r.statusCode=301,r.setHeader("Content-Type","text/html; charset=UTF-8"),r.setHeader("Content-Length",Buffer.byteLength(a)),r.setHeader("Content-Security-Policy","default-src 'self'"),r.setHeader("X-Content-Type-Options","nosniff"),r.setHeader("Location",t),r.end(a)},SendStream.prototype.pipe=function(e){var r=this._root;this.res=e;var t=decode(this.path);if(-1===t)return this.error(400),e;if(~t.indexOf("\x00"))return this.error(400),e;var a;if(null!==r){if(UP_PATH_REGEXP.test(normalize("."+sep+t)))return debug('malicious path "%s"',t),this.error(403),e;t=normalize(join(r,t)),r=normalize(r+sep),a=t.substr(r.length).split(sep)}else{if(UP_PATH_REGEXP.test(t))return debug('malicious path "%s"',t),this.error(403),e;a=normalize(t).split(sep),t=resolve(t)}if(containsDotFile(a)){var n=this._dotfiles;switch(void 0===n&&(n="."===a[a.length-1][0]?this._hidden?"allow":"ignore":"allow"),debug('%s dotfile "%s"',n,t),n){case"allow":break;case"deny":return this.error(403),e;case"ignore":default:return this.error(404),e}}return this._index.length&&this.hasTrailingSlash()?(this.sendIndex(t),e):(this.sendFile(t),e)},SendStream.prototype.send=function(e,r){var t=r.size,a=this.options,n={},s=this.res,i=this.req,o=i.headers.range,u=a.start||0;if(headersSent(s))return void this.headersAlreadySent();if(debug('pipe "%s"',e),this.setHeader(e,r),this.type(e),this.isConditionalGET()){if(this.isPreconditionFailure())return void this.error(412);if(this.isCachable()&&this.isFresh())return void this.notModified()}if(t=Math.max(0,t-u),void 0!==a.end){var l=a.end-u+1;t>l&&(t=l)}if(this._acceptRanges&&BYTES_RANGE_REGEXP.test(o)){if(o=parseRange(t,o,{combine:!0}),this.isRangeFresh()||(debug("range stale"),o=-2),-1===o)return debug("range unsatisfiable"),s.setHeader("Content-Range",contentRange("bytes",t)),this.error(416,{headers:{"Content-Range":s.getHeader("Content-Range")}});-2!==o&&1===o.length&&(debug("range %j",o),s.statusCode=206,s.setHeader("Content-Range",contentRange("bytes",t,o[0])),u+=o[0].start,t=o[0].end-o[0].start+1)}for(var c in a)n[c]=a[c];return n.start=u,n.end=Math.max(u,u+t-1),s.setHeader("Content-Length",t),"HEAD"===i.method?void s.end():void this.stream(e,n)},SendStream.prototype.sendFile=function(e){function a(n){if(t._extensions.length<=r)return n?t.onStatError(n):t.error(404);var s=e+"."+t._extensions[r++];debug('stat "%s"',s),fs.stat(s,function(e,r){return e?a(e):r.isDirectory()?a():(t.emit("file",s,r),void t.send(s,r))})}var r=0,t=this;debug('stat "%s"',e),fs.stat(e,function(r,n){return r&&"ENOENT"===r.code&&!extname(e)&&e[e.length-1]!==sep?a(r):r?t.onStatError(r):n.isDirectory()?t.redirect(e):(t.emit("file",e,n),void t.send(e,n))})},SendStream.prototype.sendIndex=function(e){function a(n){if(++r>=t._index.length)return n?t.onStatError(n):t.error(404);var s=join(e,t._index[r]);debug('stat "%s"',s),fs.stat(s,function(e,r){return e?a(e):r.isDirectory()?a():(t.emit("file",s,r),void t.send(s,r))})}var r=-1,t=this;a()},SendStream.prototype.stream=function w(e,r){var t=!1,a=this,n=this.res,w=fs.createReadStream(e,r);this.emit("stream",w),w.pipe(n),onFinished(n,function(){t=!0,destroy(w)}),w.on("error",function(e){t||(t=!0,destroy(w),a.onStatError(e))}),w.on("end",function(){a.emit("end")})},SendStream.prototype.type=function E(e){var r=this.res;if(!r.getHeader("Content-Type")){var E=mime.lookup(e);if(!E)return void debug("no content-type");var t=mime.charsets.lookup(E);debug("content-type %s",E),r.setHeader("Content-Type",E+(t?"; charset="+t:""))}},SendStream.prototype.setHeader=function(e,r){var t=this.res;if(this.emit("headers",t,e,r),this._acceptRanges&&!t.getHeader("Accept-Ranges")&&(debug("accept ranges"),t.setHeader("Accept-Ranges","bytes")),this._cacheControl&&!t.getHeader("Cache-Control")){var a="public, max-age="+Math.floor(this._maxage/1e3);debug("cache-control %s",a),t.setHeader("Cache-Control",a)}if(this._lastModified&&!t.getHeader("Last-Modified")){var n=r.mtime.toUTCString();debug("modified %s",n),t.setHeader("Last-Modified",n)}if(this._etag&&!t.getHeader("ETag")){var s=etag(r);debug("etag %s",s),t.setHeader("ETag",s)}};