"use strict";function appendMethods(e,r){for(var t=0;t<r.length;t++){var a=r[t];-1===e.indexOf(a)&&e.push(a)}}function getPathname(e){try{return parseUrl(e).pathname}catch(r){return void 0}}function getProtohost(e){if("string"!=typeof e||0===e.length||"/"===e[0])return void 0;var r=e.indexOf("?"),t=-1!==r?r:e.length,a=e.substr(0,t).indexOf("://");return-1!==a?e.substr(0,e.indexOf("/",3+a)):void 0}function gettype(e){var r=typeof e;return"object"!==r?r:toString.call(e).replace(objectRegExp,"$1")}function matchLayer(e,r){try{return e.match(r)}catch(t){return t}}function mergeParams(e,r){if("object"!=typeof r||!r)return e;var t=mixin({},r);if(!(0 in e&&0 in r))return mixin(t,e);for(var a=0,n=0;a in e;)a++;for(;n in r;)n++;for(a--;a>=0;a--)e[a+n]=e[a],n>a&&delete e[a];return mixin(t,e)}function restore(e,r){for(var t=new Array(arguments.length-2),a=new Array(arguments.length-2),n=0;n<t.length;n++)t[n]=arguments[n+2],a[n]=r[t[n]];return function(){for(var n=0;n<t.length;n++)r[t[n]]=a[n];return e.apply(this,arguments)}}function sendOptionsResponse(e,r,t){try{var a=r.join(",");e.set("Allow",a),e.send(a)}catch(n){t(n)}}function wrap(e,r){return function(){var t=new Array(arguments.length+1);t[0]=e;for(var a=0,n=arguments.length;n>a;a++)t[a+1]=arguments[a];r.apply(this,t)}}var Route=require("./route"),Layer=require("./layer"),methods=require("methods"),mixin=require("utils-merge"),debug=require("debug")("express:router"),deprecate=require("depd")("express"),flatten=require("array-flatten"),parseUrl=require("parseurl"),setPrototypeOf=require("setprototypeof"),objectRegExp=/^\[object (\S+)\]$/,slice=Array.prototype.slice,toString=Object.prototype.toString,proto=module.exports=function(e){function t(e,r,a){t.handle(e,r,a)}var r=e||{};return setPrototypeOf(t,proto),t.params={},t._params=[],t.caseSensitive=r.caseSensitive,t.mergeParams=r.mergeParams,t.strict=r.strict,t.stack=[],t};proto.param=function(e,r){if("function"==typeof e)return deprecate("router.param(fn): Refactor to use path params"),void this._params.push(e);var n,t=this._params,a=t.length;":"===e[0]&&(deprecate("router.param("+JSON.stringify(e)+", fn): Use router.param("+JSON.stringify(e.substr(1))+", fn) instead"),e=e.substr(1));for(var s=0;a>s;++s)(n=t[s](e,r))&&(r=n);if("function"!=typeof r)throw new Error("invalid param() call for "+e+", got "+r);return(this.params[e]=this.params[e]||[]).push(r),this},proto.handle=function(e,r,t){function h(t){var v="route"===t?null:t;if(o&&(e.url=e.url.substr(1),o=!1),0!==i.length&&(e.baseUrl=p,e.url=s+i+e.url.substr(s.length),i=""),"router"===v)return void setImmediate(d,null);if(n>=f.length)return void setImmediate(d,v);var m=getPathname(e);if(null==m)return d(v);for(var y,b,q;b!==!0&&n<f.length;)if(y=f[n++],b=matchLayer(y,m),q=y.route,"boolean"!=typeof b&&(v=v||b),b===!0&&q)if(v)b=!1;else{var w=e.method,x=q._handles_method(w);x||"OPTIONS"!==w||appendMethods(c,q._options()),x||"HEAD"===w||(b=!1)}if(b!==!0)return d(v);q&&(e.route=q),e.params=a.mergeParams?mergeParams(y.params,l):y.params;var E=y.path;a.process_params(y,u,e,r,function(t){return t?h(v||t):q?y.handle_request(e,r,h):void g(y,v,E,m)})}function g(t,a,n,u){if(0!==n.length){var c=u[n.length];if(c&&"/"!==c&&"."!==c)return h(a);debug("trim prefix (%s) from url %s",n,e.url),i=n,e.url=s+e.url.substr(s.length+i.length),s||"/"===e.url[0]||(e.url="/"+e.url,o=!0),e.baseUrl=p+("/"===i[i.length-1]?i.substring(0,i.length-1):i)}debug("%s %s : %s",t.name,n,e.originalUrl),a?t.handle_error(a,e,r,h):t.handle_request(e,r,h)}var a=this;debug("dispatching %s %s",e.method,e.url);var n=0,s=getProtohost(e.url)||"",i="",o=!1,u={},c=[],f=a.stack,l=e.params,p=e.baseUrl||"",d=restore(t,e,"baseUrl","next","params");e.next=h,"OPTIONS"===e.method&&(d=wrap(d,function(e,t){return t||0===c.length?e(t):void sendOptionsResponse(r,c,e)})),e.baseUrl=p,e.originalUrl=e.originalUrl||e.url,h()},proto.process_params=function(e,r,t,a,n){function h(e){return e?n(e):o>=i.length?n():(c=0,f=i[o++],u=f.name,l=t.params[u],p=s[u],d=r[u],void 0!==l&&p?d&&(d.match===l||d.error&&"route"!==d.error)?(t.params[u]=d.value,h(d.error)):(r[u]=d={error:null,match:l,value:l},void g()):h())}function g(e){var r=p[c++];if(d.value=t.params[f.name],e)return d.error=e,void h(e);if(!r)return h();try{r(t,a,g,l,f.name)}catch(n){g(n)}}var s=this.params,i=e.keys;if(!i||0===i.length)return n();var u,f,l,p,d,o=0,c=0;h()},proto.use=function(e){var r=0,t="/";if("function"!=typeof e){for(var a=e;Array.isArray(a)&&0!==a.length;)a=a[0];"function"!=typeof a&&(r=1,t=e)}var n=flatten(slice.call(arguments,r));if(0===n.length)throw new TypeError("Router.use() requires middleware functions");for(var s=0;s<n.length;s++){var e=n[s];if("function"!=typeof e)throw new TypeError("Router.use() requires middleware function but got a "+gettype(e));debug("use %o %s",t,e.name||"<anonymous>");var i=new Layer(t,{sensitive:this.caseSensitive,strict:!1,end:!1},e);i.route=void 0,this.stack.push(i)}return this},proto.route=function n(e){var n=new Route(e),r=new Layer(e,{sensitive:this.caseSensitive,strict:this.strict,end:!0},n.dispatch.bind(n));return r.route=n,this.stack.push(r),n},methods.concat("all").forEach(function(e){proto[e]=function(r){var t=this.route(r);return t[e].apply(t,slice.call(arguments,1)),this}});