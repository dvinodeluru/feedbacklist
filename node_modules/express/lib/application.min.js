"use strict";function logerror(e){"test"!==this.get("env")&&console.error(e.stack||e.toString())}function tryRender(e,r,t){try{e.render(r,t)}catch(a){t(a)}}var finalhandler=require("finalhandler"),Router=require("./router"),methods=require("methods"),middleware=require("./middleware/init"),query=require("./middleware/query"),debug=require("debug")("express:application"),View=require("./view"),http=require("http"),compileETag=require("./utils").compileETag,compileQueryParser=require("./utils").compileQueryParser,compileTrust=require("./utils").compileTrust,deprecate=require("depd")("express"),flatten=require("array-flatten"),merge=require("utils-merge"),resolve=require("path").resolve,setPrototypeOf=require("setprototypeof"),slice=Array.prototype.slice,app=exports=module.exports={},trustProxyDefaultSymbol="@@symbol:trust_proxy_default";app.init=function(){this.cache={},this.engines={},this.settings={},this.defaultConfiguration()},app.defaultConfiguration=function(){var e=process.env.NODE_ENV||"development";this.enable("x-powered-by"),this.set("etag","weak"),this.set("env",e),this.set("query parser","extended"),this.set("subdomain offset",2),this.set("trust proxy",!1),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!0}),debug("booting in %s mode",e),this.on("mount",function(e){this.settings[trustProxyDefaultSymbol]===!0&&"function"==typeof e.settings["trust proxy fn"]&&(delete this.settings["trust proxy"],delete this.settings["trust proxy fn"]),setPrototypeOf(this.request,e.request),setPrototypeOf(this.response,e.response),setPrototypeOf(this.engines,e.engines),setPrototypeOf(this.settings,e.settings)}),this.locals=Object.create(null),this.mountpath="/",this.locals.settings=this.settings,this.set("view",View),this.set("views",resolve("views")),this.set("jsonp callback name","callback"),"production"===e&&this.enable("view cache"),Object.defineProperty(this,"router",{get:function(){throw new Error("'app.router' is deprecated!\nPlease see the 3.x to 4.x migration guide for details on how to update your app.")}})},app.lazyrouter=function(){this._router||(this._router=new Router({caseSensitive:this.enabled("case sensitive routing"),strict:this.enabled("strict routing")}),this._router.use(query(this.get("query parser fn"))),this._router.use(middleware.init(this)))},app.handle=function(e,r,t){var a=this._router,n=t||finalhandler(e,r,{env:this.get("env"),onerror:logerror.bind(this)});return a?void a.handle(e,r,n):(debug("no routes defined on app"),void n())},app.use=function(e){var r=0,t="/";if("function"!=typeof e){for(var a=e;Array.isArray(a)&&0!==a.length;)a=a[0];"function"!=typeof a&&(r=1,t=e)}var n=flatten(slice.call(arguments,r));if(0===n.length)throw new TypeError("app.use() requires middleware functions");this.lazyrouter();var s=this._router;return n.forEach(function(e){return e&&e.handle&&e.set?(debug(".use app under %s",t),e.mountpath=t,e.parent=this,s.use(t,function(r,t,a){var n=r.app;e.handle(r,t,function(e){setPrototypeOf(r,n.request),setPrototypeOf(t,n.response),a(e)})}),void e.emit("mount",this)):s.use(t,e)},this),this},app.route=function(e){return this.lazyrouter(),this._router.route(e)},app.engine=function(e,r){if("function"!=typeof r)throw new Error("callback function required");var t="."!==e[0]?"."+e:e;return this.engines[t]=r,this},app.param=function(e,r){if(this.lazyrouter(),Array.isArray(e)){for(var t=0;t<e.length;t++)this.param(e[t],r);return this}return this._router.param(e,r),this},app.set=function(e,r){if(1===arguments.length)return this.settings[e];switch(debug('set "%s" to %o',e,r),this.settings[e]=r,e){case"etag":this.set("etag fn",compileETag(r));break;case"query parser":this.set("query parser fn",compileQueryParser(r));break;case"trust proxy":this.set("trust proxy fn",compileTrust(r)),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!1})}return this},app.path=function(){return this.parent?this.parent.path()+this.mountpath:""},app.enabled=function(e){return Boolean(this.set(e))},app.disabled=function(e){return!this.set(e)},app.enable=function(e){return this.set(e,!0)},app.disable=function(e){return this.set(e,!1)},methods.forEach(function(e){app[e]=function(r){if("get"===e&&1===arguments.length)return this.set(r);this.lazyrouter();var t=this._router.route(r);return t[e].apply(t,slice.call(arguments,1)),this}}),app.all=function(e){this.lazyrouter();for(var r=this._router.route(e),t=slice.call(arguments,1),a=0;a<methods.length;a++)r[methods[a]].apply(r,t);return this},app.del=deprecate["function"](app["delete"],"app.del: Use app.delete instead"),app.render=function(e,r,t){var u,a=this.cache,n=t,s=this.engines,i=r,o={};if("function"==typeof r&&(n=r,i={}),merge(o,this.locals),i._locals&&merge(o,i._locals),merge(o,i),null==o.cache&&(o.cache=this.enabled("view cache")),o.cache&&(u=a[e]),!u){var c=this.get("view");if(u=new c(e,{defaultEngine:this.get("view engine"),root:this.get("views"),engines:s}),!u.path){var l=Array.isArray(u.root)&&u.root.length>1?'directories "'+u.root.slice(0,-1).join('", "')+'" or "'+u.root[u.root.length-1]+'"':'directory "'+u.root+'"',f=new Error('Failed to lookup view "'+e+'" in views '+l);return f.view=u,n(f)}o.cache&&(a[e]=u)}tryRender(u,o,n)},app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};