"use strict";function sendfile(e,r,t,a){function i(){if(!n){n=!0;var e=new Error("Request aborted");e.code="ECONNABORTED",a(e)}}function o(){if(!n){n=!0;var e=new Error("EISDIR, read");e.code="EISDIR",a(e)}}function u(e){n||(n=!0,a(e))}function c(){n||(n=!0,a())}function f(){s=!1}function l(e){return e&&"ECONNRESET"===e.code?i():e?u(e):void(n||setImmediate(function(){return s===!1||n?void(n||(n=!0,a())):void i()}))}function p(){s=!0}var s,n=!1;r.on("directory",o),r.on("end",c),r.on("error",u),r.on("file",f),r.on("stream",p),onFinished(e,l),t.headers&&r.on("headers",function(e){for(var r=t.headers,a=Object.keys(r),n=0;n<a.length;n++){var s=a[n];e.setHeader(s,r[s])}}),r.pipe(e)}function stringify(e,r,t){return r||t?JSON.stringify(e,r,t):JSON.stringify(e)}var contentDisposition=require("content-disposition"),deprecate=require("depd")("express"),encodeUrl=require("encodeurl"),escapeHtml=require("escape-html"),http=require("http"),isAbsolute=require("./utils").isAbsolute,onFinished=require("on-finished"),path=require("path"),statuses=require("statuses"),merge=require("utils-merge"),sign=require("cookie-signature").sign,normalizeType=require("./utils").normalizeType,normalizeTypes=require("./utils").normalizeTypes,setCharset=require("./utils").setCharset,cookie=require("cookie"),send=require("send"),extname=path.extname,mime=send.mime,resolve=path.resolve,vary=require("vary"),res=Object.create(http.ServerResponse.prototype);module.exports=res;var charsetRegExp=/;\s*charset\s*=/;res.status=function(e){return this.statusCode=e,this},res.links=function(e){var r=this.get("Link")||"";return r&&(r+=", "),this.set("Link",r+Object.keys(e).map(function(r){return"<"+e[r]+'>; rel="'+r+'"'}).join(", "))},res.send=function(e){var t,a,s,r=e,n=this.req,i=this.app;switch(2===arguments.length&&("number"!=typeof arguments[0]&&"number"==typeof arguments[1]?(deprecate("res.send(body, status): Use res.status(status).send(body) instead"),this.statusCode=arguments[1]):(deprecate("res.send(status, body): Use res.status(status).send(body) instead"),this.statusCode=arguments[0],r=arguments[1])),"number"==typeof r&&1===arguments.length&&(this.get("Content-Type")||this.type("txt"),deprecate("res.send(status): Use res.sendStatus(status) instead"),this.statusCode=r,r=statuses[r]),typeof r){case"string":this.get("Content-Type")||this.type("html");break;case"boolean":case"number":case"object":if(null===r)r="";else{if(!Buffer.isBuffer(r))return this.json(r);this.get("Content-Type")||this.type("bin")}}"string"==typeof r&&(t="utf8",s=this.get("Content-Type"),"string"==typeof s&&this.set("Content-Type",setCharset(s,"utf-8"))),void 0!==r&&(Buffer.isBuffer(r)||(r=new Buffer(r,t),t=void 0),a=r.length,this.set("Content-Length",a));var o,u=void 0!==a&&i.get("etag fn");return"function"!=typeof u||this.get("ETag")||(o=u(r,t))&&this.set("ETag",o),n.fresh&&(this.statusCode=304),(204===this.statusCode||304===this.statusCode)&&(this.removeHeader("Content-Type"),this.removeHeader("Content-Length"),this.removeHeader("Transfer-Encoding"),r=""),"HEAD"===n.method?this.end():this.end(r,t),this},res.json=function(e){var r=e;2===arguments.length&&("number"==typeof arguments[1]?(deprecate("res.json(obj, status): Use res.status(status).json(obj) instead"),this.statusCode=arguments[1]):(deprecate("res.json(status, obj): Use res.status(status).json(obj) instead"),this.statusCode=arguments[0],r=arguments[1]));var t=this.app,a=t.get("json replacer"),n=t.get("json spaces"),s=stringify(r,a,n);return this.get("Content-Type")||this.set("Content-Type","application/json"),this.send(s)},res.jsonp=function(e){var r=e;2===arguments.length&&("number"==typeof arguments[1]?(deprecate("res.jsonp(obj, status): Use res.status(status).json(obj) instead"),this.statusCode=arguments[1]):(deprecate("res.jsonp(status, obj): Use res.status(status).jsonp(obj) instead"),this.statusCode=arguments[0],r=arguments[1]));var t=this.app,a=t.get("json replacer"),n=t.get("json spaces"),s=stringify(r,a,n),i=this.req.query[t.get("jsonp callback name")];return this.get("Content-Type")||(this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","application/json")),Array.isArray(i)&&(i=i[0]),"string"==typeof i&&0!==i.length&&(this.charset="utf-8",this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","text/javascript"),i=i.replace(/[^\[\]\w$.]/g,""),s=s.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),s="/**/ typeof "+i+" === 'function' && "+i+"("+s+");"),this.send(s)},res.sendStatus=function(e){var r=statuses[e]||String(e);return this.statusCode=e,this.type("txt"),this.send(r)},res.sendFile=function(e,r,t){var a=t,n=this.req,s=this,i=n.next,o=r||{};if(!e)throw new TypeError("path argument is required to res.sendFile");if("function"==typeof r&&(a=r,o={}),!o.root&&!isAbsolute(e))throw new TypeError("path must be absolute or specify root to res.sendFile");var u=encodeURI(e),c=send(n,u,o);sendfile(s,c,o,function(e){return a?a(e):e&&"EISDIR"===e.code?i():void(e&&"ECONNABORTED"!==e.code&&"write"!==e.syscall&&i(e))})},res.sendfile=function(e,r,t){var a=t,n=this.req,s=this,i=n.next,o=r||{};"function"==typeof r&&(a=r,o={});var u=send(n,e,o);sendfile(s,u,o,function(e){return a?a(e):e&&"EISDIR"===e.code?i():void(e&&"ECONNABORT"!==e.code&&"write"!==e.syscall&&i(e))})},res.sendfile=deprecate["function"](res.sendfile,"res.sendfile: Use res.sendFile instead"),res.download=function(e,r,t){var a=t,n=r;"function"==typeof r&&(a=r,n=null);var s={"Content-Disposition":contentDisposition(n||e)},i=resolve(e);return this.sendFile(i,{headers:s},a)},res.contentType=res.type=function(e){var r=-1===e.indexOf("/")?mime.lookup(e):e;return this.set("Content-Type",r)},res.format=function(e){var r=this.req,t=r.next,a=e["default"];a&&delete e["default"];var n=Object.keys(e),s=n.length>0?r.accepts(n):!1;if(this.vary("Accept"),s)this.set("Content-Type",normalizeType(s).value),e[s](r,this,t);else if(a)a();else{var i=new Error("Not Acceptable");i.status=i.statusCode=406,i.types=normalizeTypes(n).map(function(e){return e.value}),t(i)}return this},res.attachment=function(e){return e&&this.type(extname(e)),this.set("Content-Disposition",contentDisposition(e)),this},res.append=function(e,r){var t=this.get(e),a=r;return t&&(a=Array.isArray(t)?t.concat(r):Array.isArray(r)?[t].concat(r):[t,r]),this.set(e,a)},res.set=res.header=function(e,r){if(2===arguments.length){var t=Array.isArray(r)?r.map(String):String(r);if("content-type"===e.toLowerCase()){if(Array.isArray(t))throw new TypeError("Content-Type cannot be set to an Array");if(!charsetRegExp.test(t)){var a=mime.charsets.lookup(t.split(";")[0]);a&&(t+="; charset="+a.toLowerCase())}}this.setHeader(e,t)}else for(var n in e)this.set(n,e[n]);return this},res.get=function(e){return this.getHeader(e)},res.clearCookie=function(e,r){var t=merge({expires:new Date(1),path:"/"},r);return this.cookie(e,"",t)},res.cookie=function(e,r,t){var a=merge({},t),n=this.req.secret,s=a.signed;if(s&&!n)throw new Error('cookieParser("secret") required for signed cookies');var i="object"==typeof r?"j:"+JSON.stringify(r):String(r);return s&&(i="s:"+sign(i,n)),"maxAge"in a&&(a.expires=new Date(Date.now()+a.maxAge),a.maxAge/=1e3),null==a.path&&(a.path="/"),this.append("Set-Cookie",cookie.serialize(e,String(i),a)),this},res.location=function(e){var r=e;return"back"===e&&(r=this.req.get("Referrer")||"/"),this.set("Location",encodeUrl(r))},res.redirect=function(e){var t,r=e,a=302;2===arguments.length&&("number"==typeof arguments[0]?(a=arguments[0],r=arguments[1]):(deprecate("res.redirect(url, status): Use res.redirect(status, url) instead"),a=arguments[1])),r=this.location(r).get("Location"),this.format({text:function(){t=statuses[a]+". Redirecting to "+r},html:function(){var e=escapeHtml(r);t="<p>"+statuses[a]+'. Redirecting to <a href="'+e+'">'+e+"</a></p>"},"default":function(){t=""}}),this.statusCode=a,this.set("Content-Length",Buffer.byteLength(t)),"HEAD"===this.req.method?this.end():this.end(t)},res.vary=function(e){return!e||Array.isArray(e)&&!e.length?(deprecate("res.vary(): Provide a field name"),this):(vary(this,e),this)},res.render=function(e,r,t){var a=this.req.app,n=t,s=r||{},i=this.req,o=this;"function"==typeof r&&(n=r,s={}),s._locals=o.locals,n=n||function(e,r){return e?i.next(e):void o.send(r)},a.render(e,s,n)};