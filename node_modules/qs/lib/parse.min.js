"use strict";var utils=require("./utils"),has=Object.prototype.hasOwnProperty,defaults={allowDots:!1,allowPrototypes:!1,arrayLimit:20,decoder:utils.decode,delimiter:"&",depth:5,parameterLimit:1e3,plainObjects:!1,strictNullHandling:!1},parseValues=function(e,r){for(var t={},a=e.split(r.delimiter,r.parameterLimit===1/0?void 0:r.parameterLimit),n=0;n<a.length;++n){var o,u,i=a[n],s=-1===i.indexOf("]=")?i.indexOf("="):i.indexOf("]=")+1;-1===s?(o=r.decoder(i),u=r.strictNullHandling?null:""):(o=r.decoder(i.slice(0,s)),u=r.decoder(i.slice(s+1))),has.call(t,o)?t[o]=[].concat(t[o]).concat(u):t[o]=u}return t},parseObject=function(e,r,t){if(!e.length)return r;var n,a=e.shift();if("[]"===a)n=[],n=n.concat(parseObject(e,r,t));else{n=t.plainObjects?Object.create(null):{};var i="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,s=parseInt(i,10);!isNaN(s)&&a!==i&&String(s)===i&&s>=0&&t.parseArrays&&s<=t.arrayLimit?(n=[],n[s]=parseObject(e,r,t)):n[i]=parseObject(e,r,t)}return n},parseKeys=function(e,r,t){if(e){var a=t.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,n=/(\[[^[\]]*])/,i=/(\[[^[\]]*])/g,s=n.exec(a),o=s?a.slice(0,s.index):a,u=[];if(o){if(!t.plainObjects&&has.call(Object.prototype,o)&&!t.allowPrototypes)return;u.push(o)}for(var f=0;null!==(s=i.exec(a))&&f<t.depth;){if(f+=1,!t.plainObjects&&has.call(Object.prototype,s[1].slice(1,-1))&&!t.allowPrototypes)return;u.push(s[1])}return s&&u.push("["+a.slice(s.index)+"]"),parseObject(u,r,t)}};module.exports=function(e,r){var t=r||{};if(null!==t.decoder&&void 0!==t.decoder&&"function"!=typeof t.decoder)throw new TypeError("Decoder has to be a function.");if(t.delimiter="string"==typeof t.delimiter||utils.isRegExp(t.delimiter)?t.delimiter:defaults.delimiter,t.depth="number"==typeof t.depth?t.depth:defaults.depth,t.arrayLimit="number"==typeof t.arrayLimit?t.arrayLimit:defaults.arrayLimit,t.parseArrays=t.parseArrays!==!1,t.decoder="function"==typeof t.decoder?t.decoder:defaults.decoder,t.allowDots="boolean"==typeof t.allowDots?t.allowDots:defaults.allowDots,t.plainObjects="boolean"==typeof t.plainObjects?t.plainObjects:defaults.plainObjects,t.allowPrototypes="boolean"==typeof t.allowPrototypes?t.allowPrototypes:defaults.allowPrototypes,t.parameterLimit="number"==typeof t.parameterLimit?t.parameterLimit:defaults.parameterLimit,t.strictNullHandling="boolean"==typeof t.strictNullHandling?t.strictNullHandling:defaults.strictNullHandling,""===e||null===e||"undefined"==typeof e)return t.plainObjects?Object.create(null):{};for(var a="string"==typeof e?parseValues(e,t):e,n=t.plainObjects?Object.create(null):{},i=Object.keys(a),s=0;s<i.length;++s){var o=i[s],u=parseKeys(o,a[o],t);n=utils.merge(n,u,t)}return utils.compact(n)};