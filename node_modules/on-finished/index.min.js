"use strict";function onFinished(e,r){return isFinished(e)!==!1?(defer(r,null,e),e):(attachListener(e,r),e)}function isFinished(e){var r=e.socket;return"boolean"==typeof e.finished?Boolean(e.finished||r&&!r.writable):"boolean"==typeof e.complete?Boolean(e.upgrade||!r||!r.readable||e.complete&&!e.readable):void 0}function attachFinishedListener(e,r){function s(e){t.cancel(),a.cancel(),n=!0,r(e)}function i(r){e.removeListener("socket",i),n||t===a&&(a=first([[r,"error","close"]],s))}var t,a,n=!1;return t=a=first([[e,"end","finish"]],s),e.socket?void i(e.socket):(e.on("socket",i),void(void 0===e.socket&&patchAssignSocket(e,i)))}function attachListener(e,r){var t=e.__onFinished;t&&t.queue||(t=e.__onFinished=createListener(e),attachFinishedListener(e,t)),t.queue.push(r)}function createListener(e){function r(t){if(e.__onFinished===r&&(e.__onFinished=null),r.queue){var a=r.queue;r.queue=null;for(var n=0;n<a.length;n++)a[n](t,e)}}return r.queue=[],r}function patchAssignSocket(e,r){var t=e.assignSocket;"function"==typeof t&&(e.assignSocket=function(e){t.call(this,e),r(e)})}module.exports=onFinished,module.exports.isFinished=isFinished;var first=require("ee-first"),defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};