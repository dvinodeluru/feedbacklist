"use strict";function alladdrs(e,r){var t=forwarded(e);if(!r)return t;"function"!=typeof r&&(r=compile(r));for(var a=0;a<t.length-1;a++)r(t[a],a)||(t.length=a+1);return t}function compile(e){if(!e)throw new TypeError("argument is required");var r;if("string"==typeof e)r=[e];else{if(!Array.isArray(e))throw new TypeError("unsupported trust argument");r=e.slice()}for(var t=0;t<r.length;t++)e=r[t],ipranges.hasOwnProperty(e)&&(e=ipranges[e],r.splice.apply(r,[t,1].concat(e)),t+=e.length-1);return compileTrust(compileRangeSubnets(r))}function compileRangeSubnets(e){for(var r=new Array(e.length),t=0;t<e.length;t++)r[t]=parseipNotation(e[t]);return r}function compileTrust(e){var r=e.length;return 0===r?trustNone:1===r?trustSingle(e[0]):trustMulti(e)}function parseipNotation(e){var r=e.lastIndexOf("/"),t=-1!==r?e.substring(0,r):e;if(!isip(t))throw new TypeError("invalid IP address: "+t);var a=parseip(t);-1===r&&"ipv6"===a.kind()&&a.isIPv4MappedAddress()&&(a=a.toIPv4Address());var n="ipv6"===a.kind()?128:32,s=-1!==r?e.substring(r+1,e.length):null;if(s=null===s?n:digitre.test(s)?parseInt(s,10):"ipv4"===a.kind()&&isip(s)?parseNetmask(s):null,0>=s||s>n)throw new TypeError("invalid range on address: "+e);return[a,s]}function parseNetmask(e){var r=parseip(e),t=r.kind();return"ipv4"===t?r.prefixLengthFromSubnetMask():null}function proxyaddr(e,r){if(!e)throw new TypeError("req argument is required");if(!r)throw new TypeError("trust argument is required");var t=alladdrs(e,r),a=t[t.length-1];return a}function trustNone(){return!1}function trustMulti(e){return function(r){if(!isip(r))return!1;for(var a,t=parseip(r),n=t.kind(),s=0;s<e.length;s++){var i=e[s],o=i[0],u=o.kind(),p=i[1],f=t;if(n!==u){if("ipv4"===u&&!t.isIPv4MappedAddress())continue;a||(a="ipv4"===u?t.toIPv4Address():t.toIPv4MappedAddress()),f=a}if(f.match(o,p))return!0}return!1}}function trustSingle(e){var r=e[0],t=r.kind(),a="ipv4"===t,n=e[1];return function(e){if(!isip(e))return!1;var s=parseip(e),i=s.kind();if(i!==t){if(a&&!s.isIPv4MappedAddress())return!1;s=a?s.toIPv4Address():s.toIPv4MappedAddress()}return s.match(r,n)}}module.exports=proxyaddr,module.exports.all=alladdrs,module.exports.compile=compile;var forwarded=require("forwarded"),ipaddr=require("ipaddr.js"),digitre=/^[0-9]+$/,isip=ipaddr.isValid,parseip=ipaddr.parse,ipranges={linklocal:["169.254.0.0/16","fe80::/10"],loopback:["127.0.0.1/8","::1/128"],uniquelocal:["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","fc00::/7"]};