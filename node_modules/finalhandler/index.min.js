"use strict";function createHtmlDocument(e){var r=escapeHtml(e).replace(NEWLINE_REGEXP,"<br>").replace(DOUBLE_SPACE_REGEXP," &nbsp;");return'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>Error</title>\n</head>\n<body>\n<pre>'+r+"</pre>\n</body>\n</html>\n"}function finalhandler(e,r,t){var a=t||{},n=a.env||process.env.NODE_ENV||"development",s=a.onerror;return function(t){var a,i,o;return!t&&r._header?void debug("cannot 404 after headers sent"):(t?(o=getErrorStatusCode(t),void 0!==o&&(a=getErrorHeaders(t)),void 0===o&&(o=getResponseStatusCode(r)),i=getErrorMessage(t,o,n)):(o=404,i="Cannot "+e.method+" "+encodeUrl(parseUrl.original(e).pathname)),debug("default %s",o),t&&s&&defer(s,t,e,r),r._header?(debug("cannot %d after headers sent",o),void e.socket.destroy()):void send(e,r,o,a,i))}}function getErrorHeaders(e){if(!e.headers||"object"!=typeof e.headers)return void 0;for(var r=Object.create(null),t=Object.keys(e.headers),a=0;a<t.length;a++){var n=t[a];r[n]=e.headers[n]}return r}function getErrorMessage(e,r,t){var a;return"production"!==t&&(a=e.stack,a||"function"!=typeof e.toString||(a=e.toString())),a||statuses[r]}function getErrorStatusCode(e){return"number"==typeof e.status&&e.status>=400&&e.status<600?e.status:"number"==typeof e.statusCode&&e.statusCode>=400&&e.statusCode<600?e.statusCode:void 0}function getResponseStatusCode(e){var r=e.statusCode;return("number"!=typeof r||400>r||r>599)&&(r=500),r}function send(e,r,t,a,n){function s(){var s=createHtmlDocument(n);return r.statusCode=t,r.statusMessage=statuses[t],setHeaders(r,a),r.setHeader("Content-Security-Policy","default-src 'self'"),r.setHeader("X-Content-Type-Options","nosniff"),r.setHeader("Content-Type","text/html; charset=utf-8"),r.setHeader("Content-Length",Buffer.byteLength(s,"utf8")),"HEAD"===e.method?void r.end():void r.end(s,"utf8")}return isFinished(e)?void s():(unpipe(e),onFinished(e,s),void e.resume())}function setHeaders(e,r){if(r)for(var t=Object.keys(r),a=0;a<t.length;a++){var n=t[a];e.setHeader(n,r[n])}}var debug=require("debug")("finalhandler"),encodeUrl=require("encodeurl"),escapeHtml=require("escape-html"),onFinished=require("on-finished"),parseUrl=require("parseurl"),statuses=require("statuses"),unpipe=require("unpipe"),DOUBLE_SPACE_REGEXP=/\x20{2}/g,NEWLINE_REGEXP=/\n/g,defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))},isFinished=onFinished.isFinished;module.exports=finalhandler;